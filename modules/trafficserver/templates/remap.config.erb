# https://docs.trafficserver.apache.org/en/latest/admin-guide/files/remap.config.en.html
# This file is managed by Puppet.

<%- @sslredirects.each_pair do | name, property | -%>
<%- if property['mobiledomain'] =~ /\*\./ -%>
regex_redirect https://<%= property['mobiledomain'] %>/ https://<%= property['redirect'] %>/
<% elsif property['mobiledomain'] -%>
redirect https://<%= property['mobiledomain'] %>/ https://<%= property['redirect'] %>/
<%- end -%>
<%- if property['url'] =~ /\*\./ -%>
regex_redirect https://<%= property['url'] %>/ https://<%= property['redirect'] %>/
<%- else -%>
redirect https://<%= property['url'] %>/ https://<%= property['redirect'] %>/
<%- end -%>
<%- end -%>

<%- @sslcerts.each_pair do | name, property | -%>
<%- if property['mobiledomain'] -%>
map https://<%= property['mobiledomain'] %> https://backends.miraheze.org @plugin=/usr/lib/trafficserver/modules/tslua.so @pparam=/etc/trafficserver/lua/x-miraheze-debug-routing.lua @plugin=/usr/lib/trafficserver/modules/conf_remap.so @pparam=proxy.config.http.server_session_sharing.match=2
<%- else -%>
map https://<%= property['url'] %> https://backends.miraheze.org @plugin=/usr/lib/trafficserver/modules/tslua.so @pparam=/etc/trafficserver/lua/x-miraheze-debug-routing.lua @plugin=/usr/lib/trafficserver/modules/conf_remap.so @pparam=proxy.config.http.server_session_sharing.match=2
<%- end -%>
<%- end -%>

<%- @mapping_rules.each do |rule| -%>
<%= rule['type'] %> <%= rule['target'] %> <%= rule['replacement'] %> <%= rule.fetch('params', []).join(' ') %>
<%- end -%>